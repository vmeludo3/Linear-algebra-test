# LinearAlgebra_cuda 移植指南

**文档日期**: 2025-10-14  
**适用场景**: 换电脑、库位置变更、移植到新环境

---

## 🎯 需要修改的文件

换电脑后，只需修改 **1 个文件**：`CMakeLists.txt`

---

## 📝 详细修改步骤

### 步骤 1: 定位库的新位置

首先确认三个库在新电脑上的安装位置：

```bash
# 示例：在新电脑上
/new/path/to/amgx/install
/new/path/to/hypre_cpu
/new/path/to/hypre_gpu  
/new/path/to/petsc-gpu/install
/new/path/to/yaml-cpp-master
```

### 步骤 2: 修改 CMakeLists.txt

**文件位置**: `/home/zzy/Plasma/gpu/LinearAlgebra_cuda/CMakeLists.txt`

**需要修改的行**: 第 23-27 行

```cmake
# 设置库路径
set(HYPRE_CPU_DIR "/home/zzy/Plasma/gpu/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/home/zzy/Plasma/gpu/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/home/zzy/Plasma/gpu/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/home/zzy/Plasma/gpu/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master" CACHE PATH "yaml-cpp directory")
```

**修改为**（示例）:

```cmake
# 设置库路径
set(HYPRE_CPU_DIR "/new/path/to/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/new/path/to/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/new/path/to/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/new/path/to/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/new/path/to/yaml-cpp-master" CACHE PATH "yaml-cpp directory")
```

### 步骤 3: 清理旧构建并重新编译

```bash
cd /path/to/LinearAlgebra_cuda

# 清理旧构建文件
rm -rf build/

# 重新构建
./build.sh
```

**就这么简单！** ✅

---

## 🔍 详细说明

### 为什么只需修改一个文件？

**设计优势**:
- ✅ 所有路径集中在 `CMakeLists.txt` 顶部
- ✅ 使用 CMake 变量，避免硬编码
- ✅ 子模块通过变量引用，自动继承

### 各库的路径用途

| 变量 | 用途 | 包含的内容 |
|------|------|-----------|
| `HYPRE_CPU_DIR` | HYPRE CPU 版本 | `include/`, `lib/libHYPRE.a` |
| `HYPRE_GPU_DIR` | HYPRE GPU 版本 | `include/`, `lib/libHYPRE.a` |
| `PETSC_DIR` | PETSc 安装路径 | `include/`, `lib/libpetsc.so` |
| `AMGX_DIR` | AMGX 安装路径 | `include/`, `lib/libamgxsh.so` |
| `YAML_CPP_DIR` | yaml-cpp 源码 | `include/`, `build/libyaml-cpp.a` |

### 验证路径是否正确

```bash
# 验证 HYPRE CPU
ls /your/path/to/hypre_cpu/lib/libHYPRE.a

# 验证 HYPRE GPU
ls /your/path/to/hypre_gpu/lib/libHYPRE.a

# 验证 PETSc
ls /your/path/to/petsc-gpu/install/lib/libpetsc.so

# 验证 AMGX
ls /your/path/to/amgx/install/lib/libamgxsh.so

# 验证 yaml-cpp
ls /your/path/to/yaml-cpp-master/build/libyaml-cpp.a
```

如果任何一个文件不存在，说明路径错误或库未正确安装。

---

## 🚨 常见问题

### Q1: 如果库没有安装怎么办？

**需要重新安装库**。参考原始安装步骤：

#### AMGX 安装
```bash
cd /new/path/to/amgx
git clone https://github.com/NVIDIA/AMGX.git
cd AMGX
git checkout v2.4.0
git submodule update --init --recursive
mkdir build && cd build
cmake .. -DCMAKE_INSTALL_PREFIX=../install
make -j$(nproc)
make install
```

#### HYPRE 安装 (CPU 版本)
```bash
cd /new/path/to/hypre_cpu
./configure --prefix=$PWD
make -j$(nproc)
make install
```

#### HYPRE 安装 (GPU 版本)
```bash
cd /new/path/to/hypre_gpu
./configure --prefix=$PWD --with-cuda --enable-unified-memory
make -j$(nproc)
make install
```

#### PETSc 安装 (GPU 支持)
```bash
cd /new/path/to/petsc-gpu
./configure \
    --prefix=$PWD/install \
    --with-cuda=1 \
    --with-cuda-arch=89 \
    --with-cudac=nvcc \
    CUDAFLAGS="-gencode arch=compute_89,code=sm_89"
make all
make install
```

#### yaml-cpp 安装
```bash
cd /new/path/to/yaml-cpp-master
mkdir -p build && cd build
cmake ..
make -j$(nproc)
```

### Q2: GPU 架构不同怎么办？

如果新电脑的 GPU 不是 RTX 4060 Ti (SM 89)，需要修改 CUDA 架构：

**1. 查询您的 GPU 架构**
```bash
nvidia-smi --query-gpu=name,compute_cap --format=csv

# 示例输出:
# RTX 3090: SM 86
# RTX 4090: SM 89
# A100: SM 80
```

**2. 修改 CMakeLists.txt 中的架构设置**

搜索所有 `CUDA_ARCHITECTURES 89` 并替换为您的架构：

```bash
cd /path/to/LinearAlgebra_cuda
grep -r "CUDA_ARCHITECTURES" .

# 修改所有匹配的文件
# 例如: 89 → 86 (for RTX 3090)
```

**3. 重新编译 PETSc**（重要！）

PETSc 在编译时需要指定架构：
```bash
cd /new/path/to/petsc-gpu
./configure \
    --prefix=$PWD/install \
    --with-cuda=1 \
    --with-cuda-arch=86 \
    --with-cudac=nvcc \
    CUDAFLAGS="-gencode arch=compute_86,code=sm_86"
make all
make install
```

### Q3: CUDA 版本不同怎么办？

检查 CUDA 版本：
```bash
nvcc --version
```

如果 CUDA 版本不是 12.6：
- **CUDA 11.x**: 通常兼容，无需修改
- **CUDA 12.x**: 兼容
- **CUDA 10.x**: 可能需要降级某些库

### Q4: MPI 实现不同怎么办？

如果新系统使用不同的 MPI (如 MPICH 而非 OpenMPI)：

```bash
# 查找 MPI
which mpicc
which mpicxx
which mpirun

# CMake 会自动检测
# 如果检测失败，手动指定：
cmake -DMPI_C_COMPILER=/path/to/mpicc \
      -DMPI_CXX_COMPILER=/path/to/mpicxx \
      ..
```

---

## ✅ 完整迁移清单

### 迁移前准备

- [ ] 确认新电脑有 CUDA (nvcc)
- [ ] 确认新电脑有 MPI (mpicc)
- [ ] 确认新电脑有 CMake 3.18+
- [ ] 确认新电脑有 GCC 9.4+

### 库安装检查

- [ ] AMGX 已安装且路径已知
- [ ] HYPRE CPU 已安装且路径已知
- [ ] HYPRE GPU 已安装且路径已知
- [ ] PETSc 已安装且路径已知
- [ ] yaml-cpp 已编译且路径已知

### 修改文件

- [ ] 修改 `CMakeLists.txt` (第 23-27 行)
- [ ] 修改 CUDA 架构（如果 GPU 不同）
- [ ] 修改 PETSc 编译配置（如果 GPU 不同）

### 构建测试

- [ ] 删除旧的 `build/` 目录
- [ ] 运行 `./build.sh`
- [ ] 检查构建是否成功
- [ ] 运行至少一个测试验证

---

## 📋 快速迁移脚本

创建一个配置脚本 `configure_paths.sh`：

```bash
#!/bin/bash

# LinearAlgebra_cuda 路径配置脚本

# 修改这些路径为您的实际路径
HYPRE_CPU_PATH="/your/path/to/hypre_cpu"
HYPRE_GPU_PATH="/your/path/to/hypre_gpu"
PETSC_PATH="/your/path/to/petsc-gpu/install"
AMGX_PATH="/your/path/to/amgx/install"
YAML_CPP_PATH="/your/path/to/yaml-cpp-master"

# 自动修改 CMakeLists.txt
sed -i "s|set(HYPRE_CPU_DIR \".*\"|set(HYPRE_CPU_DIR \"$HYPRE_CPU_PATH\"|" CMakeLists.txt
sed -i "s|set(HYPRE_GPU_DIR \".*\"|set(HYPRE_GPU_DIR \"$HYPRE_GPU_PATH\"|" CMakeLists.txt
sed -i "s|set(PETSC_DIR \".*\"|set(PETSC_DIR \"$PETSC_PATH\"|" CMakeLists.txt
sed -i "s|set(AMGX_DIR \".*\"|set(AMGX_DIR \"$AMGX_PATH\"|" CMakeLists.txt
sed -i "s|set(YAML_CPP_DIR \".*\"|set(YAML_CPP_DIR \"$YAML_CPP_PATH\"|" CMakeLists.txt

echo "✅ CMakeLists.txt 已更新"
echo ""
echo "请验证路径:"
grep "set(.*_DIR" CMakeLists.txt | grep -v "^#"
```

**使用方法**:
```bash
# 1. 编辑脚本，修改路径
vim configure_paths.sh

# 2. 运行脚本
chmod +x configure_paths.sh
./configure_paths.sh

# 3. 重新构建
./build.sh
```

---

## 🔧 手动修改方法（推荐）

**更安全的方法是手动编辑**：

```bash
# 1. 打开 CMakeLists.txt
vim CMakeLists.txt

# 或
nano CMakeLists.txt

# 2. 找到第 23-27 行（路径设置部分）
# 按 Shift+G, 输入 :23 跳转到第23行

# 3. 修改路径
# 将旧路径替换为新路径

# 4. 保存退出
# vim: :wq
# nano: Ctrl+X, Y, Enter

# 5. 验证修改
grep "set(.*_DIR" CMakeLists.txt | grep -v "^#"

# 6. 重新构建
./build.sh
```

---

## 📍 路径配置示例

### 当前环境（原始）

```cmake
set(HYPRE_CPU_DIR "/home/zzy/Plasma/gpu/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/home/zzy/Plasma/gpu/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/home/zzy/Plasma/gpu/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/home/zzy/Plasma/gpu/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master" CACHE PATH "yaml-cpp directory")
```

### 新环境示例 1（相同用户，不同位置）

```cmake
set(HYPRE_CPU_DIR "/opt/hypre/cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/opt/hypre/gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/opt/petsc/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/opt/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/opt/yaml-cpp" CACHE PATH "yaml-cpp directory")
```

### 新环境示例 2（不同用户）

```cmake
set(HYPRE_CPU_DIR "/home/newuser/libraries/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/home/newuser/libraries/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/home/newuser/libraries/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/home/newuser/libraries/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/home/newuser/libraries/yaml-cpp" CACHE PATH "yaml-cpp directory")
```

### 新环境示例 3（使用环境变量）

```cmake
set(HYPRE_CPU_DIR "$ENV{HOME}/opt/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "$ENV{HOME}/opt/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "$ENV{HOME}/opt/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "$ENV{HOME}/opt/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "$ENV{HOME}/opt/yaml-cpp" CACHE PATH "yaml-cpp directory")
```

---

## 🛠️ 完整迁移流程

### 方案 A: 仅迁移代码（库已安装在新电脑）

```bash
# 1. 复制项目代码
scp -r /home/zzy/Plasma/gpu/LinearAlgebra_cuda newuser@newpc:/path/to/

# 2. 在新电脑上
cd /path/to/LinearAlgebra_cuda

# 3. 修改 CMakeLists.txt
vim CMakeLists.txt
# 修改第 23-27 行的路径

# 4. 验证库路径
ls /new/path/to/amgx/install/lib/libamgxsh.so
ls /new/path/to/hypre_cpu/lib/libHYPRE.a
ls /new/path/to/hypre_gpu/lib/libHYPRE.a
ls /new/path/to/petsc-gpu/install/lib/libpetsc.so
ls /new/path/to/yaml-cpp/build/libyaml-cpp.a

# 5. 重新构建
./build.sh

# 6. 测试
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver
```

### 方案 B: 迁移代码 + 重新安装库

```bash
# 1. 复制项目代码（不包含库）
scp -r /home/zzy/Plasma/gpu/LinearAlgebra_cuda newuser@newpc:/path/to/

# 2. 在新电脑上安装依赖库
# 参考上面的"库安装"部分

# 3. 修改 CMakeLists.txt
cd /path/to/LinearAlgebra_cuda
vim CMakeLists.txt
# 修改路径为新的安装位置

# 4. 构建测试
./build.sh
```

---

## ⚙️ CMake 缓存选项

### 方法 1: 使用 CMake 命令行参数（推荐）

**无需修改 CMakeLists.txt**，通过命令行传递路径：

```bash
cd LinearAlgebra_cuda
rm -rf build && mkdir build && cd build

cmake .. \
  -DHYPRE_CPU_DIR=/new/path/to/hypre_cpu \
  -DHYPRE_GPU_DIR=/new/path/to/hypre_gpu \
  -DPETSC_DIR=/new/path/to/petsc-gpu/install \
  -DAMGX_DIR=/new/path/to/amgx/install \
  -DYAML_CPP_DIR=/new/path/to/yaml-cpp

make -j$(nproc)
```

**优点**:
- ✅ 不修改源代码
- ✅ 适合临时路径变更
- ✅ 便于脚本化

### 方法 2: 使用 CMake GUI

```bash
ccmake .
# 或
cmake-gui .
```

在 GUI 中修改各个 `*_DIR` 变量。

---

## 🔄 重新编译的必要性

### 何时需要重新编译库？

| 场景 | AMGX | HYPRE | PETSc | 原因 |
|------|------|-------|-------|------|
| **换电脑（相同 CUDA 版本）** | ❌ | ❌ | ❌ | 直接复制即可 |
| **换电脑（不同 CUDA 版本）** | ✅ | ✅ | ✅ | CUDA 版本不兼容 |
| **换 GPU（不同架构）** | ❌ | ❌ | ✅ | PETSc 需要重新指定架构 |
| **换 MPI 实现** | ❌ | ✅ | ✅ | MPI 接口可能不兼容 |
| **换操作系统** | ✅ | ✅ | ✅ | 二进制不兼容 |

### 最保守的方案（推荐）

**在新电脑上重新编译所有库**，确保兼容性：
1. AMGX
2. HYPRE (CPU + GPU)
3. PETSc
4. yaml-cpp

---

## 🎯 最简迁移方案（仅修改1个文件）

如果库都已经安装好，只需：

```bash
# 1. 编辑 CMakeLists.txt
vim LinearAlgebra_cuda/CMakeLists.txt

# 2. 修改第 23-27 行
# 将路径改为新的位置

# 3. 保存并重新构建
cd LinearAlgebra_cuda
./build.sh

# 完成！
```

---

## 📦 打包迁移（包含库）

如果想打包整个环境（包括库）：

```bash
# 在旧电脑上
cd /home/zzy/Plasma/gpu
tar czf LinearAlgebra_cuda_with_libs.tar.gz \
    LinearAlgebra_cuda/ \
    amgx/ \
    hypre_cpu/ \
    hypre_gpu/ \
    petsc-gpu/ \
    ltpDeps-v2412/extract/yaml-cpp-master/

# 传输到新电脑
scp LinearAlgebra_cuda_with_libs.tar.gz newuser@newpc:/path/to/

# 在新电脑上
cd /path/to/
tar xzf LinearAlgebra_cuda_with_libs.tar.gz

# 修改 CMakeLists.txt 中的路径前缀
# 例如: /home/zzy/Plasma/gpu → /path/to
cd LinearAlgebra_cuda
vim CMakeLists.txt  # 批量替换路径

# 重新构建
./build.sh
```

---

## 🔍 验证迁移成功

```bash
# 1. 构建成功
./build.sh
# 应该显示: Build completed successfully!

# 2. 运行测试
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver

# 3. 检查结果
ls -lh ../results/
# 应该有 amgx_gpu_native_results.csv 和 .json

# 4. 对比性能
# 查看是否与原始结果相近（512×512）:
# AMGX Native + Jacobi: ~0.016 秒
```

---

## 📄 需要修改的文件汇总

| 文件 | 位置 | 需要修改的内容 | 必需？ |
|------|------|---------------|--------|
| **CMakeLists.txt** | 根目录 | 第 23-27 行：库路径 | ✅ **必需** |
| *.cu / *.cpp | 各测试目录 | 无需修改 | ❌ |
| *.h / *.cuh | common/ | 无需修改 | ❌ |
| solver_config.yaml | 根目录 | 无需修改 | ❌ |
| build.sh | 根目录 | 无需修改 | ❌ |

**总结**: 只需修改 **1 个文件** 的 **5 行** ✅

---

## 💡 最佳实践建议

### 1. 使用相对路径（如果可能）

不推荐（硬编码绝对路径）:
```cmake
set(AMGX_DIR "/home/zzy/Plasma/gpu/amgx/install")
```

推荐（相对路径或环境变量）:
```cmake
set(AMGX_DIR "$ENV{HOME}/libraries/amgx/install")
# 或
set(AMGX_DIR "${CMAKE_SOURCE_DIR}/../amgx/install")
```

### 2. 创建库安装脚本

创建 `install_dependencies.sh`，记录库的安装步骤，方便在新环境重现。

### 3. 使用 Docker（终极方案）

创建 Dockerfile，包含所有依赖，实现完全可移植：
```dockerfile
FROM nvidia/cuda:12.6-devel-ubuntu20.04
RUN apt-get update && apt-get install -y cmake openmpi-bin
# ... 安装 AMGX, HYPRE, PETSc
COPY LinearAlgebra_cuda /app/
WORKDIR /app
RUN ./build.sh
```

---

## ✅ 迁移完成检查清单

### 构建检查
- [ ] `./build.sh` 成功完成
- [ ] 所有 7 个测试程序编译成功
- [ ] 无链接错误、无找不到库的错误

### 运行检查
- [ ] AMGX 测试运行成功
- [ ] HYPRE CPU 测试运行成功
- [ ] HYPRE GPU 测试运行成功
- [ ] PETSc CPU 测试运行成功
- [ ] PETSc GPU 测试运行成功

### 性能检查（512×512）
- [ ] AMGX Native + Jacobi: ~0.01-0.02 秒
- [ ] PETSc GPU + GAMG: ~0.4-0.5 秒
- [ ] HYPRE GPU + BoomerAMG: ~0.5-0.6 秒

如果性能差异过大（>2倍），可能是 GPU 不同或配置问题。

---

**总结**: 迁移很简单，通常只需修改 CMakeLists.txt 中的 5 行路径！

