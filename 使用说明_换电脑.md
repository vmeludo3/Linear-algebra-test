# æ¢ç”µè„‘åçš„ä½¿ç”¨è¯´æ˜

**æ›´æ–°æ—¥æœŸ**: 2025-10-14  
**é€‚ç”¨åœºæ™¯**: æ¢ç”µè„‘ã€åº“ä½ç½®å˜æ›´

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥å®Œæˆï¼‰

### æ–¹æ³• A: ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰â­

```bash
# æ­¥éª¤ 1: ç¼–è¾‘ç¯å¢ƒé…ç½®æ–‡ä»¶
vim env_setup.sh
# ä¿®æ”¹ç¬¬ 10-20 è¡Œï¼Œè®¾ç½®æ‚¨çš„åº“è·¯å¾„

# æ­¥éª¤ 2: åŠ è½½ç¯å¢ƒå˜é‡
source env_setup.sh
# ä¼šè‡ªåŠ¨æ˜¾ç¤ºå½“å‰é…ç½®çš„è·¯å¾„

# æ­¥éª¤ 3: é‡æ–°æ„å»º
python3 rebuild.py --use-env
```

### æ–¹æ³• B: ç›´æ¥ä¿®æ”¹ CMakeLists.txt

```bash
# æ­¥éª¤ 1: ä¿®æ”¹ CMakeLists.txt
vim CMakeLists.txt
# ä¿®æ”¹ç¬¬ 23-27 è¡Œ

# æ­¥éª¤ 2: é‡æ–°æ„å»º
python3 rebuild.py
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 1: ä¿®æ”¹åº“è·¯å¾„

#### é€‰é¡¹ A: ç¼–è¾‘ env_setup.shï¼ˆæ¨èï¼‰

æ‰“å¼€ `env_setup.sh`:
```bash
vim env_setup.sh
```

æ‰¾åˆ°è¿™å‡ è¡Œï¼ˆç¬¬ 10-20 è¡Œï¼‰:
```bash
export AMGX_DIR="/home/zzy/Plasma/gpu/amgx/install"
export HYPRE_CPU_DIR="/home/zzy/Plasma/gpu/hypre_cpu"
export HYPRE_GPU_DIR="/home/zzy/Plasma/gpu/hypre_gpu"
export PETSC_DIR="/home/zzy/Plasma/gpu/petsc-gpu/install"
export YAML_CPP_DIR="/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master"
```

ä¿®æ”¹ä¸ºæ–°çš„è·¯å¾„:
```bash
export AMGX_DIR="/new/path/to/amgx/install"
export HYPRE_CPU_DIR="/new/path/to/hypre_cpu"
export HYPRE_GPU_DIR="/new/path/to/hypre_gpu"
export PETSC_DIR="/new/path/to/petsc-gpu/install"
export YAML_CPP_DIR="/new/path/to/yaml-cpp-master"
```

ä¿å­˜é€€å‡ºã€‚

#### é€‰é¡¹ B: ç¼–è¾‘ CMakeLists.txt

æ‰“å¼€ `CMakeLists.txt`:
```bash
vim CMakeLists.txt
```

æ‰¾åˆ°ç¬¬ 23-27 è¡Œï¼Œä¿®æ”¹è·¯å¾„ï¼Œä¿å­˜é€€å‡ºã€‚

### æ­¥éª¤ 2: åŠ è½½ç¯å¢ƒï¼ˆä»…æ–¹æ³•Aï¼‰

```bash
source env_setup.sh
```

ä¼šæ˜¾ç¤º:
```
================================================
LinearAlgebra_cuda ç¯å¢ƒé…ç½®å·²åŠ è½½
================================================

åº“è·¯å¾„:
  AMGX_DIR       = /your/new/path/to/amgx/install
  HYPRE_CPU_DIR  = /your/new/path/to/hypre_cpu
  ...
================================================
```

### æ­¥éª¤ 3: é‡æ–°æ„å»º

```bash
# ä½¿ç”¨ Python è„šæœ¬ï¼ˆæ¨èï¼‰
python3 rebuild.py

# æˆ–ä½¿ç”¨åŸå§‹è„šæœ¬
./build.sh
```

---

## ğŸ› ï¸ rebuild.py ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# æ ‡å‡†æ„å»ºï¼ˆæ¸…ç† + é…ç½® + ç¼–è¯‘ï¼‰
python3 rebuild.py

# ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéœ€å…ˆ source env_setup.shï¼‰
python3 rebuild.py --use-env

# ä»…æ¸…ç†æ„å»ºç›®å½•
python3 rebuild.py --clean-only

# Debug æ¨¡å¼ç¼–è¯‘
python3 rebuild.py --debug

# ä½¿ç”¨ 8 ä¸ªå¹¶è¡Œä»»åŠ¡
python3 rebuild.py --jobs 8

# è·³è¿‡ CMake é…ç½®ï¼Œä»…ç¼–è¯‘ï¼ˆå¿«é€Ÿé‡ç¼–è¯‘ï¼‰
python3 rebuild.py --no-cmake
```

### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--clean-only` | ä»…æ¸…ç†æ„å»ºç›®å½•ï¼Œä¸ç¼–è¯‘ | `python3 rebuild.py --clean-only` |
| `--jobs N` | ä½¿ç”¨ N ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘ | `python3 rebuild.py --jobs 16` |
| `--build-type TYPE` | è®¾ç½®æ„å»ºç±»å‹ï¼ˆRelease/Debugï¼‰ | `python3 rebuild.py --debug` |
| `--use-env` | ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®è·¯å¾„ | `python3 rebuild.py --use-env` |
| `--no-cmake` | è·³è¿‡ CMakeï¼Œä»…ç¼–è¯‘ï¼ˆå¿«é€Ÿï¼‰ | `python3 rebuild.py --no-cmake` |

### å…¸å‹ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1: é¦–æ¬¡æ„å»º

```bash
source env_setup.sh
python3 rebuild.py --use-env
```

#### åœºæ™¯ 2: ä¿®æ”¹äº†ä»£ç ï¼Œå¿«é€Ÿé‡ç¼–è¯‘

```bash
python3 rebuild.py --no-cmake
```

#### åœºæ™¯ 3: ä¿®æ”¹äº† CMakeLists.txt

```bash
python3 rebuild.py
```

#### åœºæ™¯ 4: æ¸…ç†æ„å»ºæ–‡ä»¶

```bash
python3 rebuild.py --clean-only
```

---

## âœ… éªŒè¯è¿ç§»æˆåŠŸ

### 1. éªŒè¯åº“è·¯å¾„

```bash
# æ–¹æ³• 1: ä½¿ç”¨ env_setup.sh çš„éªŒè¯åŠŸèƒ½
source env_setup.sh
# åœ¨æ–‡ä»¶æœ«å°¾å–æ¶ˆæ³¨é‡Š verify_paths å‡½æ•°è°ƒç”¨

# æ–¹æ³• 2: æ‰‹åŠ¨éªŒè¯
ls $AMGX_DIR/lib/libamgxsh.so
ls $HYPRE_CPU_DIR/lib/libHYPRE.a
ls $HYPRE_GPU_DIR/lib/libHYPRE.a
ls $PETSC_DIR/lib/libpetsc.so
ls $YAML_CPP_DIR/build/libyaml-cpp.a
```

### 2. éªŒè¯æ„å»ºæˆåŠŸ

```bash
python3 rebuild.py
# åº”è¯¥æ˜¾ç¤º:
# âœ… CMake é…ç½®æˆåŠŸ
# âœ… ç¼–è¯‘æˆåŠŸ
# âœ… æ„å»ºå®Œæˆï¼
```

### 3. éªŒè¯æµ‹è¯•è¿è¡Œ

```bash
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver

# åº”è¯¥çœ‹åˆ°:
# ===========================================
# AMGX GPU Native Poisson Solver Benchmark
# ...
# Iterations: 1
# Relative residual: 4.91381e-12
# âœ… æˆåŠŸ
```

### 4. éªŒè¯æ€§èƒ½ï¼ˆå¯é€‰ï¼‰

å¯¹æ¯”æ–°æ—§ç”µè„‘çš„æ€§èƒ½ï¼ˆ512Ã—512ï¼‰:

| æµ‹è¯• | æ—§ç”µè„‘ | æ–°ç”µè„‘ | è¯´æ˜ |
|------|--------|--------|------|
| AMGX Native + Jacobi | ~0.016s | ? | GPU æ€§èƒ½å½±å“ |
| PETSc GPU + GAMG | ~0.452s | ? | åº”è¯¥ç›¸è¿‘ |
| HYPRE GPU + BoomerAMG | ~0.531s | ? | åº”è¯¥ç›¸è¿‘ |

å¦‚æœæ€§èƒ½å·®å¼‚å¾ˆå¤§ï¼ˆ>2å€ï¼‰ï¼Œæ£€æŸ¥ï¼š
- GPU å‹å·å’Œæ€§èƒ½
- CUDA ç‰ˆæœ¬
- ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ‰¾ä¸åˆ°åº“

**é”™è¯¯**:
```
CMake Error: Could not find HYPRE library
```

**è§£å†³**:
```bash
# 1. æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®
echo $HYPRE_CPU_DIR
ls $HYPRE_CPU_DIR/lib/

# 2. é‡æ–°è®¾ç½®è·¯å¾„
vim env_setup.sh  # ä¿®æ”¹è·¯å¾„
source env_setup.sh

# 3. é‡æ–°æ„å»º
python3 rebuild.py --use-env
```

### é—®é¢˜ 2: ç¼–è¯‘é”™è¯¯

**é”™è¯¯**:
```
undefined reference to `HYPRE_XXX`
```

**è§£å†³**:
```bash
# å¯èƒ½æ˜¯åº“ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œé‡æ–°ç¼–è¯‘åº“
cd /path/to/hypre_gpu
make clean
./configure --prefix=$PWD --with-cuda
make -j$(nproc)
make install
```

### é—®é¢˜ 3: GPU æ¶æ„ä¸åŒ¹é…

**é”™è¯¯**:
```
no kernel image is available for execution on the device
```

**è§£å†³**:
```bash
# 1. æŸ¥è¯¢ GPU æ¶æ„
nvidia-smi --query-gpu=compute_cap --format=csv

# 2. ä¿®æ”¹æ‰€æœ‰ CUDA_ARCHITECTURES
cd LinearAlgebra_cuda
grep -r "CUDA_ARCHITECTURES 89" .

# 3. æ›¿æ¢ä¸ºæ‚¨çš„æ¶æ„
# ä¾‹å¦‚: 89 â†’ 86 (RTX 3090)

# 4. é‡æ–°æ„å»º
python3 rebuild.py
```

---

## ğŸ“‹ å®Œæ•´è¿ç§»æ¸…å•

### å‡†å¤‡é˜¶æ®µ

- [ ] ç¡®è®¤æ–°ç”µè„‘æœ‰ NVIDIA GPU
- [ ] å®‰è£… CUDA (`nvcc --version`)
- [ ] å®‰è£… MPI (`mpicc --version`)
- [ ] å®‰è£… CMake 3.18+ (`cmake --version`)
- [ ] å®‰è£… Python 3 (`python3 --version`)

### åº“å®‰è£…

- [ ] å®‰è£…æˆ–å¤åˆ¶ AMGX
- [ ] å®‰è£…æˆ–å¤åˆ¶ HYPRE CPU
- [ ] å®‰è£…æˆ–å¤åˆ¶ HYPRE GPU
- [ ] å®‰è£…æˆ–å¤åˆ¶ PETSc
- [ ] ç¼–è¯‘ yaml-cpp

### é…ç½®

- [ ] å¤åˆ¶ LinearAlgebra_cuda é¡¹ç›®
- [ ] ä¿®æ”¹ `env_setup.sh` æˆ– `CMakeLists.txt`
- [ ] æ£€æŸ¥ GPU æ¶æ„æ˜¯å¦éœ€è¦ä¿®æ”¹

### æ„å»ºæµ‹è¯•

- [ ] `source env_setup.sh`
- [ ] `python3 rebuild.py --use-env`
- [ ] è¿è¡Œè‡³å°‘ä¸€ä¸ªæµ‹è¯•éªŒè¯

### æ€§èƒ½éªŒè¯

- [ ] å¯¹æ¯”æ€§èƒ½æ˜¯å¦åˆç†
- [ ] æ£€æŸ¥ç»“æœæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ›å»ºåº“å®‰è£…è®°å½•

åˆ›å»º `LIBRARY_INSTALLATION.md`:
```markdown
# åº“å®‰è£…è®°å½•

## AMGX
- ç‰ˆæœ¬: v2.4.0
- å®‰è£…è·¯å¾„: /path/to/amgx/install
- å®‰è£…å‘½ä»¤:
  git clone ... && cd AMGX
  git checkout v2.4.0
  mkdir build && cd build
  cmake .. -DCMAKE_INSTALL_PREFIX=../install
  make -j$(nproc) && make install

## HYPRE
...
```

### 2. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶

å°† `env_setup.sh` åŠ å…¥ Gitï¼Œä½†æ·»åŠ è¯´æ˜ï¼š
```bash
# env_setup.sh - æ¨¡æ¿æ–‡ä»¶
# å¤åˆ¶ä¸º env_setup_local.sh å¹¶ä¿®æ”¹è·¯å¾„
# env_setup_local.sh åœ¨ .gitignore ä¸­
```

### 3. è‡ªåŠ¨åŒ–è„šæœ¬

åˆ›å»º `setup_new_machine.sh`:
```bash
#!/bin/bash
# æ–°æœºå™¨è‡ªåŠ¨åŒ–è®¾ç½®è„šæœ¬

# 1. æ£€æŸ¥ä¾èµ–
command -v nvcc >/dev/null || { echo "CUDA not found"; exit 1; }
command -v mpicc >/dev/null || { echo "MPI not found"; exit 1; }
command -v cmake >/dev/null || { echo "CMake not found"; exit 1; }

# 2. å®‰è£…åº“
./install_dependencies.sh

# 3. é…ç½®ç¯å¢ƒ
source env_setup.sh

# 4. æ„å»ºé¡¹ç›®
python3 rebuild.py --use-env

echo "âœ… è®¾ç½®å®Œæˆï¼"
```

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- **ç§»æ¤æŒ‡å—.md**: è¯¦ç»†çš„ç§»æ¤æ­¥éª¤å’Œè¯´æ˜
- **README.md**: é¡¹ç›®ä¸»é¡µ
- **CMakeLists.txt**: éœ€è¦ä¿®æ”¹çš„é…ç½®æ–‡ä»¶

---

## ğŸ¯ æ€»ç»“

**æœ€ç®€å•çš„æ–¹æ³•**:
1. ç¼–è¾‘ `env_setup.sh`ï¼ˆä¿®æ”¹ 5 è¡Œè·¯å¾„ï¼‰
2. `source env_setup.sh`
3. `python3 rebuild.py --use-env`

**å®Œæˆï¼** âœ…

---

**æç¤º**: å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå‚è€ƒ `ç§»æ¤æŒ‡å—.md` è·å–è¯¦ç»†è¯´æ˜ã€‚

