# 换电脑后的使用说明

**更新日期**: 2025-10-14  
**适用场景**: 换电脑、库位置变更

---

## 🚀 快速开始（3步完成）

### 方法 A: 使用环境变量（推荐）⭐

```bash
# 步骤 1: 编辑环境配置文件
vim env_setup.sh
# 修改第 10-20 行，设置您的库路径

# 步骤 2: 加载环境变量
source env_setup.sh
# 会自动显示当前配置的路径

# 步骤 3: 重新构建
python3 rebuild.py --use-env
```

### 方法 B: 直接修改 CMakeLists.txt

```bash
# 步骤 1: 修改 CMakeLists.txt
vim CMakeLists.txt
# 修改第 23-27 行

# 步骤 2: 重新构建
python3 rebuild.py
```

---

## 📝 详细步骤

### 步骤 1: 修改库路径

#### 选项 A: 编辑 env_setup.sh（推荐）

打开 `env_setup.sh`:
```bash
vim env_setup.sh
```

找到这几行（第 10-20 行）:
```bash
export AMGX_DIR="/home/zzy/Plasma/gpu/amgx/install"
export HYPRE_CPU_DIR="/home/zzy/Plasma/gpu/hypre_cpu"
export HYPRE_GPU_DIR="/home/zzy/Plasma/gpu/hypre_gpu"
export PETSC_DIR="/home/zzy/Plasma/gpu/petsc-gpu/install"
export YAML_CPP_DIR="/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master"
```

修改为新的路径:
```bash
export AMGX_DIR="/new/path/to/amgx/install"
export HYPRE_CPU_DIR="/new/path/to/hypre_cpu"
export HYPRE_GPU_DIR="/new/path/to/hypre_gpu"
export PETSC_DIR="/new/path/to/petsc-gpu/install"
export YAML_CPP_DIR="/new/path/to/yaml-cpp-master"
```

保存退出。

#### 选项 B: 编辑 CMakeLists.txt

打开 `CMakeLists.txt`:
```bash
vim CMakeLists.txt
```

找到第 23-27 行，修改路径，保存退出。

### 步骤 2: 加载环境（仅方法A）

```bash
source env_setup.sh
```

会显示:
```
================================================
LinearAlgebra_cuda 环境配置已加载
================================================

库路径:
  AMGX_DIR       = /your/new/path/to/amgx/install
  HYPRE_CPU_DIR  = /your/new/path/to/hypre_cpu
  ...
================================================
```

### 步骤 3: 重新构建

```bash
# 使用 Python 脚本（推荐）
python3 rebuild.py

# 或使用原始脚本
./build.sh
```

---

## 🛠️ rebuild.py 使用方法

### 基本用法

```bash
# 标准构建（清理 + 配置 + 编译）
python3 rebuild.py

# 使用环境变量配置（需先 source env_setup.sh）
python3 rebuild.py --use-env

# 仅清理构建目录
python3 rebuild.py --clean-only

# Debug 模式编译
python3 rebuild.py --debug

# 使用 8 个并行任务
python3 rebuild.py --jobs 8

# 跳过 CMake 配置，仅编译（快速重编译）
python3 rebuild.py --no-cmake
```

### 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `--clean-only` | 仅清理构建目录，不编译 | `python3 rebuild.py --clean-only` |
| `--jobs N` | 使用 N 个并行任务编译 | `python3 rebuild.py --jobs 16` |
| `--build-type TYPE` | 设置构建类型（Release/Debug） | `python3 rebuild.py --debug` |
| `--use-env` | 使用环境变量配置路径 | `python3 rebuild.py --use-env` |
| `--no-cmake` | 跳过 CMake，仅编译（快速） | `python3 rebuild.py --no-cmake` |

### 典型使用场景

#### 场景 1: 首次构建

```bash
source env_setup.sh
python3 rebuild.py --use-env
```

#### 场景 2: 修改了代码，快速重编译

```bash
python3 rebuild.py --no-cmake
```

#### 场景 3: 修改了 CMakeLists.txt

```bash
python3 rebuild.py
```

#### 场景 4: 清理构建文件

```bash
python3 rebuild.py --clean-only
```

---

## ✅ 验证迁移成功

### 1. 验证库路径

```bash
# 方法 1: 使用 env_setup.sh 的验证功能
source env_setup.sh
# 在文件末尾取消注释 verify_paths 函数调用

# 方法 2: 手动验证
ls $AMGX_DIR/lib/libamgxsh.so
ls $HYPRE_CPU_DIR/lib/libHYPRE.a
ls $HYPRE_GPU_DIR/lib/libHYPRE.a
ls $PETSC_DIR/lib/libpetsc.so
ls $YAML_CPP_DIR/build/libyaml-cpp.a
```

### 2. 验证构建成功

```bash
python3 rebuild.py
# 应该显示:
# ✅ CMake 配置成功
# ✅ 编译成功
# ✅ 构建完成！
```

### 3. 验证测试运行

```bash
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver

# 应该看到:
# ===========================================
# AMGX GPU Native Poisson Solver Benchmark
# ...
# Iterations: 1
# Relative residual: 4.91381e-12
# ✅ 成功
```

### 4. 验证性能（可选）

对比新旧电脑的性能（512×512）:

| 测试 | 旧电脑 | 新电脑 | 说明 |
|------|--------|--------|------|
| AMGX Native + Jacobi | ~0.016s | ? | GPU 性能影响 |
| PETSc GPU + GAMG | ~0.452s | ? | 应该相近 |
| HYPRE GPU + BoomerAMG | ~0.531s | ? | 应该相近 |

如果性能差异很大（>2倍），检查：
- GPU 型号和性能
- CUDA 版本
- 编译优化选项

---

## 🔧 故障排查

### 问题 1: 找不到库

**错误**:
```
CMake Error: Could not find HYPRE library
```

**解决**:
```bash
# 1. 检查路径是否正确
echo $HYPRE_CPU_DIR
ls $HYPRE_CPU_DIR/lib/

# 2. 重新设置路径
vim env_setup.sh  # 修改路径
source env_setup.sh

# 3. 重新构建
python3 rebuild.py --use-env
```

### 问题 2: 编译错误

**错误**:
```
undefined reference to `HYPRE_XXX`
```

**解决**:
```bash
# 可能是库版本不兼容，重新编译库
cd /path/to/hypre_gpu
make clean
./configure --prefix=$PWD --with-cuda
make -j$(nproc)
make install
```

### 问题 3: GPU 架构不匹配

**错误**:
```
no kernel image is available for execution on the device
```

**解决**:
```bash
# 1. 查询 GPU 架构
nvidia-smi --query-gpu=compute_cap --format=csv

# 2. 修改所有 CUDA_ARCHITECTURES
cd LinearAlgebra_cuda
grep -r "CUDA_ARCHITECTURES 89" .

# 3. 替换为您的架构
# 例如: 89 → 86 (RTX 3090)

# 4. 重新构建
python3 rebuild.py
```

---

## 📋 完整迁移清单

### 准备阶段

- [ ] 确认新电脑有 NVIDIA GPU
- [ ] 安装 CUDA (`nvcc --version`)
- [ ] 安装 MPI (`mpicc --version`)
- [ ] 安装 CMake 3.18+ (`cmake --version`)
- [ ] 安装 Python 3 (`python3 --version`)

### 库安装

- [ ] 安装或复制 AMGX
- [ ] 安装或复制 HYPRE CPU
- [ ] 安装或复制 HYPRE GPU
- [ ] 安装或复制 PETSc
- [ ] 编译 yaml-cpp

### 配置

- [ ] 复制 LinearAlgebra_cuda 项目
- [ ] 修改 `env_setup.sh` 或 `CMakeLists.txt`
- [ ] 检查 GPU 架构是否需要修改

### 构建测试

- [ ] `source env_setup.sh`
- [ ] `python3 rebuild.py --use-env`
- [ ] 运行至少一个测试验证

### 性能验证

- [ ] 对比性能是否合理
- [ ] 检查结果文件是否生成

---

## 💡 最佳实践

### 1. 创建库安装记录

创建 `LIBRARY_INSTALLATION.md`:
```markdown
# 库安装记录

## AMGX
- 版本: v2.4.0
- 安装路径: /path/to/amgx/install
- 安装命令:
  git clone ... && cd AMGX
  git checkout v2.4.0
  mkdir build && cd build
  cmake .. -DCMAKE_INSTALL_PREFIX=../install
  make -j$(nproc) && make install

## HYPRE
...
```

### 2. 使用版本控制

将 `env_setup.sh` 加入 Git，但添加说明：
```bash
# env_setup.sh - 模板文件
# 复制为 env_setup_local.sh 并修改路径
# env_setup_local.sh 在 .gitignore 中
```

### 3. 自动化脚本

创建 `setup_new_machine.sh`:
```bash
#!/bin/bash
# 新机器自动化设置脚本

# 1. 检查依赖
command -v nvcc >/dev/null || { echo "CUDA not found"; exit 1; }
command -v mpicc >/dev/null || { echo "MPI not found"; exit 1; }
command -v cmake >/dev/null || { echo "CMake not found"; exit 1; }

# 2. 安装库
./install_dependencies.sh

# 3. 配置环境
source env_setup.sh

# 4. 构建项目
python3 rebuild.py --use-env

echo "✅ 设置完成！"
```

---

## 📄 相关文档

- **移植指南.md**: 详细的移植步骤和说明
- **README.md**: 项目主页
- **CMakeLists.txt**: 需要修改的配置文件

---

## 🎯 总结

**最简单的方法**:
1. 编辑 `env_setup.sh`（修改 5 行路径）
2. `source env_setup.sh`
3. `python3 rebuild.py --use-env`

**完成！** ✅

---

**提示**: 如果遇到问题，参考 `移植指南.md` 获取详细说明。

