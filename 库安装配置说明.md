# 五个库的安装和编译配置说明

**文档日期**: 2025-10-14  
**包含库**: AMGX, HYPRE-CPU, HYPRE-GPU, PETSc-CPU, PETSc-GPU

---

## 📋 库清单

| 库 | 版本 | 模式 | 安装路径 |
|---|------|------|---------|
| **AMGX** | v2.4.0 | GPU | `/home/zzy/Plasma/gpu/amgx/install` |
| **HYPRE-CPU** | 2.31.0 | CPU | `/home/zzy/Plasma/gpu/hypre_cpu` |
| **HYPRE-GPU** | 2.31.0 | GPU | `/home/zzy/Plasma/gpu/hypre_gpu` |
| **PETSc** | 3.22.2 | CPU+GPU | `/home/zzy/Plasma/gpu/petsc-gpu/install` |
| **yaml-cpp** | master | - | `/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master` |

**注意**: PETSc 是同一个安装，支持 CPU 和 GPU 两种模式（通过矩阵类型区分）

---

## 1️⃣ AMGX v2.4.0

### 基本信息

- **官方仓库**: https://github.com/NVIDIA/AMGX
- **版本**: v2.4.0 (稳定版)
- **类型**: 仅 GPU
- **源代码**: `/home/zzy/Plasma/gpu/amgx`
- **安装路径**: `/home/zzy/Plasma/gpu/amgx/install`

### 编译配置

```bash
# 1. 下载源代码
cd /home/zzy/Plasma/gpu
git clone https://github.com/NVIDIA/AMGX.git amgx
cd amgx

# 2. 切换到稳定版本
git checkout v2.4.0

# 3. 初始化子模块
git submodule update --init --recursive

# 4. 创建构建目录
mkdir build && cd build

# 5. CMake 配置
cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=../install \
  -DCUDA_ARCH="70;75;80;86;89;90"

# 6. 编译和安装
make -j$(nproc)
make install
```

### 关键配置参数

| 参数 | 值 | 说明 |
|------|---|------|
| `CMAKE_BUILD_TYPE` | Release | 优化构建 |
| `CMAKE_INSTALL_PREFIX` | ../install | 安装路径 |
| `CUDA_ARCH` | 70;75;80;86;89;90 | 支持的 GPU 架构 |

### 生成的文件

```
amgx/install/
├── include/
│   ├── amgx_c.h          # C API 头文件
│   └── amgx_config.h     # 配置头文件
├── lib/
│   ├── libamgx.a         # 静态库 (533 MB)
│   ├── libamgxsh.so      # 动态库 (377 MB)
│   ├── configs/          # 30+ 个预配置文件
│   └── examples/         # 示例程序
└── ...
```

### 链接方式

**动态链接（推荐）**:
```cmake
target_link_libraries(your_target ${AMGX_DIR}/lib/libamgxsh.so)
```

**静态链接**:
```cmake
target_link_libraries(your_target ${AMGX_DIR}/lib/libamgx.a gomp)  # 需要 gomp (OpenMP)
```

---

## 2️⃣ HYPRE-CPU 2.31.0

### 基本信息

- **官方网站**: https://computing.llnl.gov/projects/hypre-scalable-linear-solvers-multigrid-methods
- **版本**: 2.31.0
- **类型**: CPU 优化
- **安装路径**: `/home/zzy/Plasma/gpu/hypre_cpu`

### 编译配置

```bash
# 1. 下载源代码
cd /home/zzy/Plasma/gpu
wget https://github.com/hypre-space/hypre/archive/refs/tags/v2.31.0.tar.gz
tar xzf v2.31.0.tar.gz
mv hypre-2.31.0 hypre_cpu
cd hypre_cpu/src

# 2. 配置（CPU 模式）
./configure \
  --prefix=/home/zzy/Plasma/gpu/hypre_cpu \
  --enable-shared \
  --with-MPI \
  --with-openmp \
  CFLAGS="-O3 -march=native" \
  CXXFLAGS="-O3 -march=native"

# 3. 编译和安装
make -j$(nproc)
make install
```

### 关键配置参数

| 参数 | 值 | 说明 |
|------|---|------|
| `--prefix` | /home/zzy/Plasma/gpu/hypre_cpu | 安装路径 |
| `--enable-shared` | - | 生成动态库 |
| `--with-MPI` | - | 启用 MPI 支持 |
| `--with-openmp` | - | 启用 OpenMP 并行 |
| `CFLAGS` | -O3 -march=native | CPU 优化 |

### 生成的文件

```
hypre_cpu/
├── include/
│   ├── HYPRE.h
│   ├── HYPRE_parcsr_ls.h
│   └── ...
└── lib/
    └── libHYPRE.a        # 静态库
```

### 链接方式

```cmake
target_link_libraries(your_target ${HYPRE_CPU_DIR}/lib/libHYPRE.a)
```

---

## 3️⃣ HYPRE-GPU 2.31.0

### 基本信息

- **版本**: 2.31.0
- **类型**: GPU 加速（CUDA + Unified Memory）
- **安装路径**: `/home/zzy/Plasma/gpu/hypre_gpu`

### 编译配置

```bash
# 1. 下载源代码
cd /home/zzy/Plasma/gpu
wget https://github.com/hypre-space/hypre/archive/refs/tags/v2.31.0.tar.gz
tar xzf v2.31.0.tar.gz
mv hypre-2.31.0 hypre_gpu
cd hypre_gpu/src

# 2. 配置（GPU 模式）⭐ 关键
./configure \
  --prefix=/home/zzy/Plasma/gpu/hypre_gpu \
  --enable-shared \
  --with-MPI \
  --with-cuda \
  --enable-unified-memory \
  --with-gpu-arch=89 \
  CFLAGS="-O3" \
  CXXFLAGS="-O3" \
  CUFLAGS="-O3 -gencode arch=compute_89,code=sm_89"

# 3. 编译和安装
make -j$(nproc)
make install
```

### 关键配置参数

| 参数 | 值 | 说明 |
|------|---|------|
| `--prefix` | /home/zzy/Plasma/gpu/hypre_gpu | 安装路径 |
| `--with-cuda` | - | ⭐ 启用 CUDA 支持 |
| `--enable-unified-memory` | - | ⭐ 启用统一内存（WSL 必需） |
| `--with-gpu-arch` | 89 | GPU 架构（RTX 4060 Ti） |
| `CUFLAGS` | -O3 -gencode... | CUDA 编译优化 |

### GPU 架构对照表

| GPU 型号 | 架构代码 | `--with-gpu-arch` |
|---------|---------|------------------|
| RTX 3090 | SM 86 | `--with-gpu-arch=86` |
| RTX 4060 Ti | SM 89 | `--with-gpu-arch=89` |
| RTX 4090 | SM 89 | `--with-gpu-arch=89` |
| A100 | SM 80 | `--with-gpu-arch=80` |
| V100 | SM 70 | `--with-gpu-arch=70` |

### 生成的文件

```
hypre_gpu/
├── include/
│   ├── HYPRE.h
│   ├── HYPRE_parcsr_ls.h
│   └── ...
└── lib/
    └── libHYPRE.a        # 静态库（包含 CUDA 代码）
```

### 链接方式

```cmake
target_link_libraries(your_target 
    ${HYPRE_GPU_DIR}/lib/libHYPRE.a
    -L/usr/local/cuda/lib64
    -lcusparse
    -lcublas
    -lcurand
    -lcusolver
)
```

---

## 4️⃣ PETSc 3.22.2（统一安装，支持 CPU + GPU）

### 基本信息

- **官方网站**: https://petsc.org/
- **版本**: 3.22.2
- **类型**: CPU + GPU 混合
- **源代码**: `/home/zzy/Plasma/gpu/petsc-gpu/petsc-3.22.2`
- **安装路径**: `/home/zzy/Plasma/gpu/petsc-gpu/install`

### 编译配置（GPU 支持）⭐

```bash
# 1. 下载源代码
cd /home/zzy/Plasma/gpu
mkdir -p petsc-gpu && cd petsc-gpu
wget https://web.cels.anl.gov/projects/petsc/download/release-snapshots/petsc-3.22.2.tar.gz
tar xzf petsc-3.22.2.tar.gz
cd petsc-3.22.2

# 2. 配置（CPU + GPU 支持）⭐ 关键
./configure \
  --prefix=/home/zzy/Plasma/gpu/petsc-gpu/install \
  --with-cc=mpicc \
  --with-cxx=mpicxx \
  --with-fc=mpif90 \
  --with-cuda=1 \
  --with-cuda-dir=/usr/local/cuda \
  --with-cuda-arch=89 \
  --with-cudac=nvcc \
  CUDAFLAGS="-O3 -gencode arch=compute_89,code=sm_89" \
  COPTFLAGS="-O3 -march=native" \
  CXXOPTFLAGS="-O3 -march=native" \
  FOPTFLAGS="-O3" \
  --with-debugging=0 \
  --with-shared-libraries=1

# 3. 编译
make PETSC_DIR=/home/zzy/Plasma/gpu/petsc-gpu/petsc-3.22.2 \
     PETSC_ARCH=arch-linux-c-opt all

# 4. 安装
make PETSC_DIR=/home/zzy/Plasma/gpu/petsc-gpu/petsc-3.22.2 \
     PETSC_ARCH=arch-linux-c-opt install

# 5. 测试（可选）
make PETSC_DIR=/home/zzy/Plasma/gpu/petsc-gpu/install test
```

### 关键配置参数

| 参数 | 值 | 说明 |
|------|---|------|
| `--prefix` | .../install | 安装路径 |
| `--with-cuda` | 1 | ⭐ 启用 CUDA 支持 |
| `--with-cuda-arch` | 89 | ⭐ GPU 架构（RTX 4060 Ti） |
| `CUDAFLAGS` | -gencode... | ⭐ 仅编译特定架构（避免内核错误） |
| `--with-debugging` | 0 | 禁用调试（性能优化） |
| `--with-shared-libraries` | 1 | 生成动态库 |
| `COPTFLAGS` | -O3 -march=native | CPU 优化 |

### 为什么 PETSc 同时支持 CPU 和 GPU？

PETSc 通过**矩阵和向量类型**区分 CPU 和 GPU：

**CPU 模式**:
```cpp
MatSetType(A, MATAIJ);        // CPU 矩阵
VecSetType(b, VECSTANDARD);   // CPU 向量
```

**GPU 模式**:
```cpp
MatSetType(A, MATAIJCUSPARSE); // GPU 矩阵（cuSPARSE）
VecSetType(b, VECCUDA);        // GPU 向量
```

**同一个 PETSc 安装，根据类型自动选择 CPU 或 GPU！**

### 生成的文件

```
petsc-gpu/install/
├── include/
│   ├── petsc.h
│   ├── petscmat.h
│   ├── petscvec.h
│   ├── petscksp.h
│   └── ...
└── lib/
    ├── libpetsc.so.3.22.2  # 主动态库
    ├── libpetsc.so.3.22    # 版本链接
    └── libpetsc.so         # 主链接
```

### 链接方式

```cmake
target_link_libraries(your_target ${PETSC_DIR}/lib/libpetsc.so)
```

---

## 5️⃣ yaml-cpp (master)

### 基本信息

- **官方仓库**: https://github.com/jbeder/yaml-cpp
- **版本**: master 分支
- **类型**: C++ 库
- **源代码**: `/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master`

### 编译配置

```bash
# 1. 进入源代码目录
cd /home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master

# 2. 创建构建目录
mkdir -p build && cd build

# 3. CMake 配置
cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DYAML_CPP_BUILD_TESTS=OFF \
  -DYAML_CPP_BUILD_TOOLS=OFF

# 4. 编译
make -j$(nproc)

# 注意：无需 make install，直接使用 build/ 中的库
```

### 生成的文件

```
yaml-cpp-master/
├── include/
│   └── yaml-cpp/
│       ├── yaml.h
│       └── ...
└── build/
    └── libyaml-cpp.a     # 静态库
```

### 链接方式

```cmake
target_include_directories(your_target PRIVATE ${YAML_CPP_DIR}/include)
target_link_libraries(your_target ${YAML_CPP_DIR}/build/libyaml-cpp.a)
```

---

## 📊 库对比总结

### 编译复杂度

| 库 | 复杂度 | 编译时间 | 配置难度 |
|---|--------|---------|---------|
| **yaml-cpp** | ⭐ 简单 | ~1 分钟 | 简单 |
| **AMGX** | ⭐⭐ 中等 | ~5 分钟 | 中等 |
| **HYPRE-CPU** | ⭐⭐ 中等 | ~10 分钟 | 简单 |
| **HYPRE-GPU** | ⭐⭐⭐ 复杂 | ~15 分钟 | 中等 |
| **PETSc** | ⭐⭐⭐⭐ 很复杂 | ~20-30 分钟 | 复杂 |

### 依赖关系

```
yaml-cpp (无依赖)
   ↓
AMGX (依赖: CUDA, MPI)
   ↓
HYPRE-CPU (依赖: MPI)
   ↓
HYPRE-GPU (依赖: MPI, CUDA)
   ↓
PETSc (依赖: MPI, CUDA, BLAS/LAPACK)
```

**建议安装顺序**: yaml-cpp → AMGX → HYPRE-CPU → HYPRE-GPU → PETSc

---

## 🔧 在新电脑上重新安装

### 场景 1: 新电脑（从头安装）

```bash
# 创建工作目录
mkdir -p ~/libraries && cd ~/libraries

# 1. 安装 yaml-cpp
git clone https://github.com/jbeder/yaml-cpp.git
cd yaml-cpp && mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
cd ../..

# 2. 安装 AMGX
git clone https://github.com/NVIDIA/AMGX.git amgx
cd amgx && git checkout v2.4.0
git submodule update --init --recursive
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../install
make -j$(nproc) && make install
cd ../..

# 3. 安装 HYPRE-CPU
wget https://github.com/hypre-space/hypre/archive/refs/tags/v2.31.0.tar.gz
tar xzf v2.31.0.tar.gz
mv hypre-2.31.0 hypre_cpu && cd hypre_cpu/src
./configure --prefix=$PWD/../.. --enable-shared --with-MPI
make -j$(nproc) && make install
cd ../..

# 4. 安装 HYPRE-GPU
cp -r hypre_cpu hypre_gpu && cd hypre_gpu/src
make clean
./configure --prefix=$PWD/../.. --with-cuda --enable-unified-memory --with-gpu-arch=89
make -j$(nproc) && make install
cd ../..

# 5. 安装 PETSc
wget https://web.cels.anl.gov/projects/petsc/download/release-snapshots/petsc-3.22.2.tar.gz
tar xzf petsc-3.22.2.tar.gz && cd petsc-3.22.2
./configure \
  --prefix=$PWD/../petsc-gpu/install \
  --with-cuda=1 --with-cuda-arch=89 \
  --with-cudac=nvcc \
  CUDAFLAGS="-O3 -gencode arch=compute_89,code=sm_89" \
  --with-debugging=0 --with-shared-libraries=1
make all && make install
```

### 场景 2: 复制现有安装

```bash
# 在旧电脑上打包
cd /home/zzy/Plasma/gpu
tar czf libraries.tar.gz amgx/ hypre_cpu/ hypre_gpu/ petsc-gpu/ ltpDeps-v2412/

# 复制到新电脑
scp libraries.tar.gz newpc:/path/to/

# 在新电脑上解压
cd /path/to/
tar xzf libraries.tar.gz

# 验证库文件
ls amgx/install/lib/libamgxsh.so
ls hypre_cpu/lib/libHYPRE.a
ls hypre_gpu/lib/libHYPRE.a
ls petsc-gpu/install/lib/libpetsc.so
```

**注意**: 如果 CUDA 版本不同或 GPU 架构不同，需要重新编译！

---

## 📝 配置文件模板

### env_setup.sh 模板

```bash
# 根据您的实际路径修改
export AMGX_DIR="/path/to/amgx/install"
export HYPRE_CPU_DIR="/path/to/hypre_cpu"
export HYPRE_GPU_DIR="/path/to/hypre_gpu"
export PETSC_DIR="/path/to/petsc-gpu/install"
export YAML_CPP_DIR="/path/to/yaml-cpp-master"
```

### CMakeLists.txt 模板

```cmake
# 在 LinearAlgebra_cuda/CMakeLists.txt 中（第 23-27 行）
set(HYPRE_CPU_DIR "/path/to/hypre_cpu" CACHE PATH "HYPRE CPU installation directory")
set(HYPRE_GPU_DIR "/path/to/hypre_gpu" CACHE PATH "HYPRE GPU installation directory")
set(PETSC_DIR "/path/to/petsc-gpu/install" CACHE PATH "PETSc directory")
set(AMGX_DIR "/path/to/amgx/install" CACHE PATH "AMGX installation directory")
set(YAML_CPP_DIR "/path/to/yaml-cpp-master" CACHE PATH "yaml-cpp directory")
```

---

## 🎯 常见问题

### Q1: HYPRE-CPU 和 HYPRE-GPU 有什么区别？

| 特性 | HYPRE-CPU | HYPRE-GPU |
|------|-----------|-----------|
| 编译选项 | 标准 | `--with-cuda` |
| 库文件 | libHYPRE.a | libHYPRE.a（含 CUDA） |
| 代码 | 相同 | 相同 |
| 运行时 | 自动选择 CPU | 自动选择 GPU |

**关键**: 通过 `HYPRE_SetMemoryLocation()` 和 `HYPRE_SetExecutionPolicy()` 控制

### Q2: 为什么 PETSc 不需要分 CPU 和 GPU 版本？

PETSc 的设计哲学：**统一接口，多后端**

- 同一个库，编译时包含 CPU 和 GPU 后端
- 通过矩阵/向量类型选择后端
- `MATAIJ` = CPU, `MATAIJCUSPARSE` = GPU
- 更灵活，但库更大

### Q3: 如果只需要 CPU，能简化安装吗？

可以！只安装 CPU 版本：

```bash
# 仅安装 HYPRE-CPU
# 仅安装 PETSc（不带 --with-cuda）

# 在 LinearAlgebra_cuda 中禁用 GPU 测试
cmake .. \
  -DBUILD_HYPRE_GPU_TESTS=OFF \
  -DBUILD_PETSC_GPU_TESTS=OFF \
  -DBUILD_AMGX_TESTS=OFF \
  -DBUILD_AMGX_GPU_NATIVE_TESTS=OFF \
  -DBUILD_PETSC_GPU_NATIVE_TESTS=OFF \
  -DBUILD_HYPRE_GPU_NATIVE_TESTS=OFF
```

---

## 🔍 验证安装

### 验证脚本

创建 `verify_installation.sh`:

```bash
#!/bin/bash

echo "验证库安装..."

# AMGX
if [ -f "/home/zzy/Plasma/gpu/amgx/install/lib/libamgxsh.so" ]; then
    echo "✅ AMGX: 已安装"
else
    echo "❌ AMGX: 未找到"
fi

# HYPRE CPU
if [ -f "/home/zzy/Plasma/gpu/hypre_cpu/lib/libHYPRE.a" ]; then
    echo "✅ HYPRE CPU: 已安装"
else
    echo "❌ HYPRE CPU: 未找到"
fi

# HYPRE GPU
if [ -f "/home/zzy/Plasma/gpu/hypre_gpu/lib/libHYPRE.a" ]; then
    echo "✅ HYPRE GPU: 已安装"
else
    echo "❌ HYPRE GPU: 未找到"
fi

# PETSc
if [ -f "/home/zzy/Plasma/gpu/petsc-gpu/install/lib/libpetsc.so" ]; then
    echo "✅ PETSc: 已安装"
else
    echo "❌ PETSc: 未找到"
fi

# yaml-cpp
if [ -f "/home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master/build/libyaml-cpp.a" ]; then
    echo "✅ yaml-cpp: 已编译"
else
    echo "❌ yaml-cpp: 未找到"
fi
```

---

## 📚 参考资料

### 官方文档

- **AMGX**: https://github.com/NVIDIA/AMGX
- **HYPRE**: https://hypre.readthedocs.io/
- **PETSc**: https://petsc.org/release/documentation/
- **yaml-cpp**: https://github.com/jbeder/yaml-cpp

### 已有的安装文档

- **AMGX**: `/home/zzy/Plasma/gpu/amgx/INSTALL_INFO.md`
- **PETSc**: `/home/zzy/Plasma/gpu/petsc-gpu/INSTALL_INFO.md`

---

## 🎯 快速参考卡

### 各库的 CMake 变量

```cmake
# AMGX
set(AMGX_DIR "/path/to/amgx/install")
include_directories(${AMGX_DIR}/include)
target_link_libraries(target ${AMGX_DIR}/lib/libamgxsh.so gomp)

# HYPRE-CPU
set(HYPRE_CPU_DIR "/path/to/hypre_cpu")
include_directories(${HYPRE_CPU_DIR}/include)
target_link_libraries(target ${HYPRE_CPU_DIR}/lib/libHYPRE.a)

# HYPRE-GPU
set(HYPRE_GPU_DIR "/path/to/hypre_gpu")
include_directories(${HYPRE_GPU_DIR}/include)
target_link_libraries(target 
    ${HYPRE_GPU_DIR}/lib/libHYPRE.a
    -lcusparse -lcublas -lcurand -lcusolver)

# PETSc
set(PETSC_DIR "/path/to/petsc-gpu/install")
include_directories(${PETSC_DIR}/include)
target_link_libraries(target ${PETSC_DIR}/lib/libpetsc.so)

# yaml-cpp
set(YAML_CPP_DIR "/path/to/yaml-cpp")
include_directories(${YAML_CPP_DIR}/include)
target_link_libraries(target ${YAML_CPP_DIR}/build/libyaml-cpp.a)
```

### 各库的编译命令总结

```bash
# AMGX
cmake .. -DCMAKE_INSTALL_PREFIX=../install && make -j && make install

# HYPRE-CPU
./configure --prefix=$PWD && make -j && make install

# HYPRE-GPU
./configure --prefix=$PWD --with-cuda --enable-unified-memory --with-gpu-arch=89
make -j && make install

# PETSc
./configure --prefix=../install --with-cuda=1 --with-cuda-arch=89 \
  CUDAFLAGS="-gencode arch=compute_89,code=sm_89" --with-debugging=0
make all && make install

# yaml-cpp
cmake .. && make -j
```

---

**总结**: 5个库的配置各有特点，关键是 GPU 相关的参数设置正确！

