# LinearAlgebra_cuda 工具使用指南

**更新日期**: 2025-10-14  
**包含工具**: 4个脚本

---

## 📋 工具清单

| 工具 | 类型 | 用途 | 优先级 |
|------|------|------|--------|
| `rebuild.py` | Python | 自动化构建脚本 | ⭐⭐⭐⭐⭐ |
| `env_setup.sh` | Bash | 环境配置脚本 | ⭐⭐⭐⭐⭐ |
| `build.sh` | Bash | 传统构建脚本 | ⭐⭐⭐ |
| `run_benchmarks.sh` | Bash | 运行所有测试 | ⭐⭐⭐ |

---

## 🔧 工具 1: rebuild.py（推荐）⭐

### 功能

**自动化 CMake 构建脚本**，支持：
- ✅ 自动清理旧构建
- ✅ 自动配置 CMake
- ✅ 并行编译
- ✅ 彩色输出
- ✅ 列出生成的可执行文件
- ✅ 支持环境变量配置
- ✅ 多种构建选项

### 基本用法

```bash
# 标准构建（清理 + 配置 + 编译）
python3 rebuild.py

# 使用环境变量配置（推荐）
source env_setup.sh
python3 rebuild.py --use-env
```

### 所有参数

```bash
python3 rebuild.py [选项]

选项:
  --clean-only              仅清理构建，不编译
  --jobs N, -j N            使用 N 个并行任务（默认：CPU核心数）
  --build-type TYPE         Release 或 Debug（默认：Release）
  --use-env                 使用环境变量配置路径
  --no-cmake                跳过 CMake 配置，仅编译
  --help, -h                显示帮助信息
```

### 使用示例

```bash
# 示例 1: 首次构建
python3 rebuild.py

# 示例 2: 使用环境变量（推荐）
source env_setup.sh
python3 rebuild.py --use-env

# 示例 3: 快速重编译（修改代码后）
python3 rebuild.py --no-cmake

# 示例 4: Debug 模式编译
python3 rebuild.py --build-type Debug

# 示例 5: 使用 16 个线程编译（高性能机器）
python3 rebuild.py --jobs 16

# 示例 6: 仅清理
python3 rebuild.py --clean-only

# 示例 7: 完整的工作流
source env_setup.sh
python3 rebuild.py --use-env --jobs 12
```

### 输出示例

```
======================================================================
                       LinearAlgebra_cuda 构建脚本                        
======================================================================

项目目录: /home/zzy/Plasma/gpu/LinearAlgebra_cuda
构建目录: /home/zzy/Plasma/gpu/LinearAlgebra_cuda/build

[步骤 1] 清理旧构建文件
  删除目录: /home/zzy/Plasma/gpu/LinearAlgebra_cuda/build
✅ 旧构建文件已清理
  创建目录: /home/zzy/Plasma/gpu/LinearAlgebra_cuda/build

[步骤 2] 配置 CMake (构建类型: Release)
  使用 CMakeLists.txt 中的默认路径
  
  运行: cmake .. -DCMAKE_BUILD_TYPE=Release
  
... (CMake 输出) ...
✅ CMake 配置成功

[步骤 3] 编译项目
  使用 8 个并行任务
  运行: make -j8
  
... (编译输出) ...
✅ 编译成功

[步骤 4] 列出生成的可执行文件

  找到 8 个可执行文件:

    ✅ ./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver (1.7 MB)
    ✅ ./amgx_tests/amgx_poisson_solver (1.7 MB)
    ...

──────────────────────────────────────────────────────────────────────
下一步操作:

  1. 运行测试:
     cd build
     ./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver
     
  ...
──────────────────────────────────────────────────────────────────────

✅ 构建完成！
```

---

## 🌍 工具 2: env_setup.sh（推荐）⭐

### 功能

**环境配置脚本**，用于：
- ✅ 集中管理库路径
- ✅ 设置环境变量
- ✅ 配置运行时库路径
- ✅ 验证路径是否正确
- ✅ 便于在不同环境间切换

### 使用方法

```bash
# 1. 编辑配置文件
vim env_setup.sh

# 2. 修改第 10-20 行的路径
export AMGX_DIR="/your/path/to/amgx/install"
export HYPRE_CPU_DIR="/your/path/to/hypre_cpu"
export HYPRE_GPU_DIR="/your/path/to/hypre_gpu"
export PETSC_DIR="/your/path/to/petsc-gpu/install"
export YAML_CPP_DIR="/your/path/to/yaml-cpp-master"

# 3. 加载环境变量
source env_setup.sh
```

### 输出示例

```
================================================
LinearAlgebra_cuda 环境配置已加载
================================================

库路径:
  AMGX_DIR       = /home/zzy/Plasma/gpu/amgx/install
  HYPRE_CPU_DIR  = /home/zzy/Plasma/gpu/hypre_cpu
  HYPRE_GPU_DIR  = /home/zzy/Plasma/gpu/hypre_gpu
  PETSC_DIR      = /home/zzy/Plasma/gpu/petsc-gpu/install
  YAML_CPP_DIR   = /home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master

CUDA 路径:
  CUDA_HOME      = /usr/local/cuda

使用方法:
  1. 修改本文件中的路径（第 10-20 行）
  2. source env_setup.sh
  3. python3 rebuild.py

================================================
```

### 可选功能：路径验证

在 `env_setup.sh` 文件末尾，取消注释：
```bash
# 自动验证（注释掉此行可禁用自动验证）
verify_paths  # ← 删除前面的 #
```

会自动检查所有库文件是否存在：
```
验证库路径...
  ✅ AMGX: /home/zzy/Plasma/gpu/amgx/install
  ✅ HYPRE CPU: /home/zzy/Plasma/gpu/hypre_cpu
  ✅ HYPRE GPU: /home/zzy/Plasma/gpu/hypre_gpu
  ✅ PETSc: /home/zzy/Plasma/gpu/petsc-gpu/install
  ✅ yaml-cpp: /home/zzy/Plasma/gpu/ltpDeps-v2412/extract/yaml-cpp-master

✅ 所有库路径验证通过！
```

---

## 🔨 工具 3: build.sh（传统）

### 功能

**传统构建脚本**，简单直接：
- ✅ 清理旧构建
- ✅ 运行 CMake
- ✅ 运行 Make
- ❌ 不支持环境变量
- ❌ 输出较少

### 使用方法

```bash
./build.sh
```

### 何时使用

- 快速构建
- 不需要修改路径
- 习惯传统脚本

**建议**: 对于换电脑场景，**推荐使用 `rebuild.py`**

---

## 🏃 工具 4: run_benchmarks.sh

### 功能

**运行所有测试脚本**（如果存在）

### 使用方法

```bash
./run_benchmarks.sh
```

会依次运行所有测试模块。

---

## 💡 推荐工作流

### 工作流 1: 换电脑（推荐）⭐

```bash
# 1. 编辑配置
vim env_setup.sh
# 修改库路径

# 2. 加载环境
source env_setup.sh
# 检查路径是否正确

# 3. 构建项目
python3 rebuild.py --use-env
# 自动化构建

# 4. 运行测试
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver
```

### 工作流 2: 修改代码后重编译

```bash
# 修改了源代码 (.cpp/.cu)
python3 rebuild.py --no-cmake
# 跳过 CMake，直接编译（更快）
```

### 工作流 3: 修改配置后重编译

```bash
# 修改了 solver_config.yaml
# 无需重新编译，直接运行测试即可
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver
```

### 工作流 4: 修改 CMakeLists.txt 后

```bash
# 修改了 CMakeLists.txt 或添加了新模块
python3 rebuild.py
# 完整重新构建
```

### 工作流 5: Debug 调试

```bash
# 1. Debug 模式编译
python3 rebuild.py --build-type Debug

# 2. 使用 gdb 调试
cd build
gdb ./amgx_tests/amgx_poisson_solver
```

---

## 🔍 对比：各工具的优缺点

### rebuild.py (Python)

**优点**:
- ✅ 功能最全面
- ✅ 彩色输出，易于阅读
- ✅ 错误提示详细
- ✅ 支持多种参数
- ✅ 列出生成的文件
- ✅ 支持环境变量

**缺点**:
- ⚠️ 需要 Python 3

**推荐场景**: 日常使用、换电脑、团队协作

### build.sh (Bash)

**优点**:
- ✅ 简单直接
- ✅ 无需 Python
- ✅ 传统习惯

**缺点**:
- ❌ 功能有限
- ❌ 不支持环境变量
- ❌ 输出较少

**推荐场景**: 快速构建、自动化脚本

### env_setup.sh (Bash)

**优点**:
- ✅ 配置与代码分离
- ✅ 便于团队共享
- ✅ 支持路径验证
- ✅ 清晰显示配置

**缺点**:
- ⚠️ 需要 `source` 而非直接运行

**推荐场景**: 所有需要配置路径的场景

---

## 🎯 常见任务快速参考

| 任务 | 命令 |
|------|------|
| **首次使用** | `./build.sh` |
| **换电脑** | `vim env_setup.sh` → `source env_setup.sh` → `python3 rebuild.py --use-env` |
| **修改代码** | `python3 rebuild.py --no-cmake` |
| **修改配置** | 无需重编译，直接运行测试 |
| **清理构建** | `python3 rebuild.py --clean-only` |
| **Debug模式** | `python3 rebuild.py --build-type Debug` |
| **快速重编译** | `python3 rebuild.py --no-cmake -j16` |
| **验证路径** | `source env_setup.sh`（查看输出） |

---

## 📝 换电脑完整示例

### 场景: 从实验室电脑迁移到工作站

#### 在实验室电脑上

```bash
cd /home/zzy/Plasma/gpu
tar czf LinearAlgebra_cuda.tar.gz LinearAlgebra_cuda/
scp LinearAlgebra_cuda.tar.gz workstation:/home/user/
```

#### 在工作站上

```bash
# 1. 解压
cd /home/user
tar xzf LinearAlgebra_cuda.tar.gz
cd LinearAlgebra_cuda

# 2. 编辑配置（假设库在 /opt/）
vim env_setup.sh

# 修改为:
# export AMGX_DIR="/opt/amgx/install"
# export HYPRE_CPU_DIR="/opt/hypre_cpu"
# export HYPRE_GPU_DIR="/opt/hypre_gpu"
# export PETSC_DIR="/opt/petsc-gpu/install"
# export YAML_CPP_DIR="/opt/yaml-cpp"

# 3. 加载环境
source env_setup.sh

# 4. 构建
python3 rebuild.py --use-env

# 5. 测试
cd build
./amgx_gpu_native_tests/amgx_gpu_native_poisson_solver

# 完成！
```

---

## 🚨 故障排查

### 问题 1: rebuild.py 找不到

**错误**: `python3: command not found` 或 `rebuild.py: No such file`

**解决**:
```bash
# 检查 Python
which python3
python3 --version  # 需要 3.6+

# 检查文件
ls -lh rebuild.py
chmod +x rebuild.py  # 确保可执行
```

### 问题 2: env_setup.sh 无效

**错误**: 运行后环境变量未设置

**原因**: 直接运行而非 `source`

**解决**:
```bash
# 错误方式
./env_setup.sh  # ❌ 环境变量仅在子shell中

# 正确方式
source env_setup.sh  # ✅ 环境变量在当前shell中
```

### 问题 3: 库路径错误

**错误**: `CMake Error: Could not find AMGX`

**解决**:
```bash
# 1. 检查环境变量
echo $AMGX_DIR

# 2. 检查文件是否存在
ls $AMGX_DIR/lib/libamgxsh.so

# 3. 如果路径错误，重新编辑
vim env_setup.sh
source env_setup.sh

# 4. 重新构建
python3 rebuild.py --use-env
```

---

## 💡 高级技巧

### 技巧 1: 创建多套配置

为不同环境创建不同的配置文件：

```bash
# 实验室环境
cp env_setup.sh env_setup_lab.sh
vim env_setup_lab.sh  # 配置实验室路径

# 工作站环境
cp env_setup.sh env_setup_workstation.sh
vim env_setup_workstation.sh  # 配置工作站路径

# 使用时
source env_setup_lab.sh  # 或
source env_setup_workstation.sh
```

### 技巧 2: 添加到 .bashrc（自动加载）

如果总是使用相同路径：

```bash
# 在 ~/.bashrc 末尾添加
echo "source /home/user/LinearAlgebra_cuda/env_setup.sh" >> ~/.bashrc

# 重新加载
source ~/.bashrc

# 之后每次打开终端都会自动加载
```

### 技巧 3: 使用别名

在 `~/.bashrc` 中添加：

```bash
alias lrebuild='cd /home/user/LinearAlgebra_cuda && python3 rebuild.py'
alias ltest='cd /home/user/LinearAlgebra_cuda/build'
alias lresults='cd /home/user/LinearAlgebra_cuda/results && ls -lh'

# 使用
lrebuild --use-env    # 快速构建
ltest                 # 快速跳转到构建目录
lresults              # 查看结果
```

### 技巧 4: 增量编译（修改单个文件）

```bash
# 修改了 amgx_tests/poisson_solver.cpp

# 方法 1: 使用 rebuild.py（推荐）
python3 rebuild.py --no-cmake

# 方法 2: 直接 make
cd build
make -j8

# 方法 2 更快，但仅适合小改动
```

---

## 📊 性能对比

| 任务 | build.sh | rebuild.py | rebuild.py --no-cmake |
|------|----------|------------|----------------------|
| 完整构建 | 30-40s | 30-40s | - |
| 重新配置 | 30-40s | 30-40s | - |
| 仅编译 | - | - | 10-15s |
| 清理 | 手动 `rm -rf` | `--clean-only` | - |

**结论**: `rebuild.py --no-cmake` 最快（适合代码修改后）

---

## 🎓 最佳实践

### 推荐的目录结构

```
~/projects/
├── libraries/              # 库安装目录
│   ├── amgx/
│   ├── hypre_cpu/
│   ├── hypre_gpu/
│   ├── petsc-gpu/
│   └── yaml-cpp/
│
└── LinearAlgebra_cuda/     # 项目目录
    ├── env_setup.sh        # 配置为 ~/projects/libraries/*
    ├── rebuild.py
    └── ...
```

### 推荐的工作流程

```bash
# 每天开始工作
cd ~/projects/LinearAlgebra_cuda
source env_setup.sh

# 修改代码
vim amgx_tests/poisson_solver.cpp

# 快速重编译
python3 rebuild.py --no-cmake

# 测试
cd build
./amgx_tests/amgx_poisson_solver

# 查看结果
cd ../results
cat amgx_results.csv
```

---

## 📖 相关文档

- **使用说明_换电脑.md**: 换电脑快速上手
- **移植指南.md**: 详细的移植步骤
- **README.md**: 项目主页

---

## ✅ 总结

**最简单的使用方法**:

```bash
# 换电脑后
vim env_setup.sh              # 修改 5 行路径
source env_setup.sh           # 加载环境
python3 rebuild.py --use-env  # 一键构建
```

**3 个命令，完成迁移！** ✅

